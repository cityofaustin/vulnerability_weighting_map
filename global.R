require(tidyverse)
require(tidycensus)
require(sf)
require(tigris)

options(
  scipen = 999,
  digits = 4,
  tigris_class = "sf",
  tigris_use_cache = T
)

source("4_scripts/1_data-processing/01_load_spatial_resources.R")
source("3_functions/get_counties_from_cbsa.R")
source("3_functions/get_states_from_stcnty_fips.R")

## 01. Determine and input target region's FIPS/CBSA codes and places #####

## TODO: Enter a region to look up in the line below to search for the correct CBSA FIPS 
REGION_OF_INTEREST <- "austin" 

# Use code below to 
county2msa %>% 
  filter(str_detect(cbsaname15, regex(REGION_OF_INTEREST, ignore_case = TRUE)))

## TODO: Enter the correct CBSA FIPS code found from lookup above to determine the counties that are part of that CBSA
COUNTIES_TO_DOWNLOAD <- get_counties_from_cbsa(12420)

## Determine states from counties
STATES_TO_DOWNLOAD <- get_states_from_stcnty_fips(COUNTIES_TO_DOWNLOAD)

## Determine states from counties
STATES_TO_DOWNLOAD <- get_states_from_stcnty_fips(COUNTIES_TO_DOWNLOAD)

TRACTS.SF <- tigris::tracts(STATES_TO_DOWNLOAD, cb = TRUE, year = 2020) %>%
  filter(substr(GEOID, 1, 5) %in% COUNTIES_TO_DOWNLOAD)

TARGET_EPSG <- crsuggest::suggest_top_crs(TRACTS.SF, units = "us-ft")
WEB_EPSG <- 4326

## Main places in CBSA
PLACES_IN_CBSA <- tigris::places(STATES_TO_DOWNLOAD) %>%
  st_filter(., filter(tigris::counties(state = STATES_TO_DOWNLOAD, cb = T), GEOID %in% COUNTIES_TO_DOWNLOAD)) %>%
  st_transform(TARGET_EPSG) %>%
  arrange(desc(ALAND)) %>%
  head() 

## Grab GEOID/FIPS code of the primary place of interest, which is USUALLY
## the largest by land area. 
PRIMARY_PLACE <-  PLACES_IN_CBSA[1,]

TRACTS.SF <- st_transform(TRACTS.SF, TARGET_EPSG)

## Identify a list of tracts that are within the primary place of interest
## Adjust negative distance buffer to fit desired tolerance
TRACTS_IN_PLACE <- TRACTS.SF %>%
  st_filter(., st_buffer(PRIMARY_PLACE, dist = -1320)) %>%
  pull(GEOID)

## Create new variable on whether that tract is in the primary place of interest
TRACTS.SF <- TRACTS.SF %>%
  mutate(in_primary_place = GEOID %in% TRACTS_IN_PLACE)

