library(shiny)
library(tidyverse)
library(leaflet)
library(RColorBrewer)
library(sf)
library(rlang)
library(scales)
library(shinythemes)
library(rio)
library(shinyBS)

#### Utility functions ####
range01 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}

# setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

vulnerability_data <- readRDS("acs_vuln_weighting_data.rds") %>%
  mutate(NAME = substr(GEOID, 6, 11) %>% as.numeric(),
         NAME = paste0(NAME / 100, ", ", county))

base_data_labels <- rio::import("base_data_download_labels.xlsx")

usb <- readRDS("primary_place_outline.rds")

ui <- 
  fluidPage(
    theme = shinytheme("lumen"), ##(lumen, paper, simplex, flatly, yeti) ## See interactive themes: https://gallery.shinyapps.io/117-shinythemes/
    div(# Main Panel
      titlePanel(title = "Austin Vulnerability Weighting Tool"),
      style = "flex-grow:1; resize:horizontal; overflow: hidden; position:relative; margin-right: 310px ",
      tags$style(type = "text/css", "#vulnerabilitymap {height: calc(90vh) !important;}"),
      leafletOutput("vulnerabilitymap")
    ),
    wellPanel( # Sidebar
      style = "overflow-y: auto; position:fixed; width:300px; top:0; bottom:0;; right:0",
      shiny::helpText("Explore the demographic variables that go into calculating",
                      "an economic vulnerability index."),
      radioButtons(inputId = "geo_filter", label = "Filter for Region or Place:", choices = c("Austin Region" = "Region", "City of Austin" = "Primary Place"), selected = "Primary Place"),
      # bsButton(inputId = "geo_filter_button", label = "?", style = "info", 
      #          size = "extra-small", type = "action"),
      bsTooltip("geo_filter", "Select the extent of the mapping results: Census tracts within the 5-county Austin region, or tracts within the City of Austin</br>NOTE: The the extent of your selection influences the outcome of the mapping results, as each tract is compared to the entire selection.",
                placement = "bottom", trigger = "hover", options = list(container = "body")),             
      radioButtons(inputId = "calc_method", label = "Weighting Method:", choices = c("Percentile Rank" = "Percentile", "Z-Score" = "Z-Score"), selected = "Percentile"),
      bsTooltip("calc_method", "Percentile rank sums together the raw rank of the variables (e.g., a tract with 80% renters might rank in the 90th percentile).<br>The Z-score method sums together the number of standard deviations a tract is above or below the average (e.g., 80% renters might be 1.8 standard deviations above the mean).",
                placement = "bottom", trigger = "hover", options = list(container = "body")), 
      # sliderInput("z_tolerance", "Z-Tolerance Bottom Code:", min = 2, max = 7, value = 3),
      hr(),
      shiny::helpText("Slide bar to desired weight for each variable",
                      "you wish to add to the vulnerability model.",
                      "The weight corresponds to the relative importance",
                      "of that variable. 5 = very important, 0 = turned off.",
                      "Download the results using button at bottom."),
      mainPanel(),
      sliderInput("wt_people_of_color", "RACE: People of color", min = 0, max = 5, value = 0),
      sliderInput("wt_black_native_and_latinx_people", "RACE: Black, Native and Latinx people", min = 0, max = 5, value = 0),
      
      sliderInput("wt_commuters", "WORK: Commuters", min = 0, max = 5, value = 0),
      sliderInput("wt_unemployed_persons", "WORK: Unemployed persons", min = 0, max = 5, value = 0),
      sliderInput("wt_insufficient_commuter_vehicles", "WORK: Insufficient commuter vehicles", min = 0, max = 5, value = 0),
      
      sliderInput("wt_persons_with_disabilities", "DISABILITY: Persons w disabilities", min = 0, max = 5, value = 0),
      sliderInput("wt_households_with_limited_english", "LEP: Households w limited English", min = 0, max = 5, value = 0),
      
      sliderInput("wt_adults_without_4_yr_degree", "EDUCATION: Adults w/o 4-year degree", min = 0, max = 5, value = 0),
      
      sliderInput("wt_students_k_12", "AGE: Students (K-12)", min = 0, max = 5, value = 0),
      sliderInput("wt_retirees_65", "AGE: Retirees (65+)", min = 0, max = 5, value = 0),
      
      sliderInput("wt_median_household_income", "INCOME: Median household income ", min = 0, max = 5, value = 0),
      sliderInput("wt_food_stamps_recipients", "HOUSEHOLDS: Food stamps recipients", min = 0, max = 5, value = 0),
      sliderInput("wt_renter_households", "HOUSEHOLDS: Renter households", min = 0, max = 5, value = 0),
      sliderInput("wt_cost_burdened_renters_35_percent", "HOUSEHOLDS: Renters paying 35%+ on rent", min = 0, max = 5, value = 0),
      sliderInput("wt_cost_burdened_owners_with_mortgage_35_percent", "HOUSEHOLDS: Owners paying 35%+ on mortgage", min = 0, max = 5, value = 0),
      sliderInput("wt_overcrowded_households", "HOUSEHOLDS: Overcrowded households", min = 0, max = 5, value = 0),
      sliderInput("wt_no_computer_access", "HOUSEHOLDS: No computer access", min = 0, max = 5, value = 0),
      sliderInput("wt_no_broadband_access", "HOUSEHOLDS: No broadband access", min = 0, max = 5, value = 0),
      
      actionButton("tabBut", label = "View Table"),
      br(),
      downloadButton("download_geojson", label = "Download Weighted Results"),
      br(),
      downloadButton("download_basedata", label = "Download Base Data"),
      hr(),
      div("View code on ", tags$a(href="https://github.com/cityofaustin/vulnerability_weighting_map","GitHub"), ".")
    ),
    bsModal(id = "modalTable", title = "Data Table", trigger = "tabBut", 
            size = "large",
            dataTableOutput("resultsTable"))
  )





##### Begin server #####
server <- function(input, output, session) {
  
  filtered_vulnerability_data <- reactive({
    if(input$geo_filter == "Primary Place"){
      vulnerability_data <- vulnerability_data %>%
        filter(in_primary_place == TRUE)
    }
    
    filtered_data <- vulnerability_data %>%
      mutate(across(.cols = c(people_of_color:no_broadband_access), 
                    .fns = list(rnk = ~cume_dist(.),
                                z = ~scale(.))),
             across(ends_with("_z"), ~ case_when(. > 3 ~ 3,
                                                 . < -3 ~ -3,
                                                 T ~ .)),
             median_household_income_rnk = 1 - median_household_income_rnk,
             median_household_income_z = -median_household_income_z)
    
    filtered_data
  })
  
  reweighted <- reactive({
    
    if(input$calc_method == "Z-Score"){
      reweighted_data <- filtered_vulnerability_data() %>%
        mutate(
          weighted_people_of_color = people_of_color_z * input$wt_people_of_color,
          weighted_black_native_and_latinx_people = black_native_and_latinx_people_z * input$wt_black_native_and_latinx_people,
          weighted_households_with_limited_english = households_with_limited_english_z * input$wt_households_with_limited_english,
          weighted_commuters = commuters_z * input$wt_commuters,
          weighted_median_household_income = median_household_income_z * input$wt_median_household_income,
          weighted_food_stamps_recipients = food_stamps_recipients_z * input$wt_food_stamps_recipients,
          weighted_renter_households = renter_households_z * input$wt_renter_households,
          weighted_unemployed_persons = unemployed_persons_z * input$wt_unemployed_persons,
          weighted_cost_burdened_renters_35_percent = cost_burdened_renters_35_percent_z * input$wt_cost_burdened_renters_35_percent,
          weighted_cost_burdened_owners_with_mortgage_35_percent = cost_burdened_owners_with_mortgage_35_percent_z * input$wt_cost_burdened_owners_with_mortgage_35_percent,
          weighted_insufficient_commuter_vehicles = insufficient_commuter_vehicles_z * input$wt_insufficient_commuter_vehicles,
          weighted_persons_with_disabilities = persons_with_disabilities_z * input$wt_persons_with_disabilities,
          weighted_adults_without_4_yr_degree = adults_without_4_yr_degree_z * input$wt_adults_without_4_yr_degree,
          weighted_students_k_12 = students_k_12_z * input$wt_students_k_12,
          weighted_retirees_65 = retirees_65_z * input$wt_retirees_65,
          weighted_overcrowded_households = overcrowded_households_z * input$wt_overcrowded_households,
          weighted_no_computer_access = no_computer_access_z * input$wt_no_computer_access,
          weighted_no_broadband_access = no_broadband_access_z * input$wt_no_broadband_access,
          
          composite_score = weighted_people_of_color + weighted_black_native_and_latinx_people + 
            weighted_households_with_limited_english + weighted_median_household_income + 
            weighted_food_stamps_recipients + weighted_renter_households + weighted_commuters +
            weighted_unemployed_persons + weighted_cost_burdened_renters_35_percent + 
            weighted_cost_burdened_owners_with_mortgage_35_percent + 
            weighted_insufficient_commuter_vehicles + weighted_persons_with_disabilities + 
            weighted_adults_without_4_yr_degree + weighted_students_k_12 + weighted_retirees_65 + 
            weighted_overcrowded_households + weighted_no_computer_access + weighted_no_broadband_access,# + weighted_user_data,
          
          indexed_score = round(range01(composite_score, na.rm = T) * 100, 0)
        ) %>%
        arrange(desc(indexed_score)) 
    }
    
    if(input$calc_method == "Percentile"){
      reweighted_data <- filtered_vulnerability_data() %>%
        mutate(
          weighted_people_of_color = people_of_color_rnk * input$wt_people_of_color,
          weighted_black_native_and_latinx_people = black_native_and_latinx_people_rnk * input$wt_black_native_and_latinx_people,
          weighted_households_with_limited_english = households_with_limited_english_rnk * input$wt_households_with_limited_english,
          weighted_commuters = commuters_rnk * input$wt_commuters,
          weighted_median_household_income = median_household_income_rnk * input$wt_median_household_income,
          weighted_food_stamps_recipients = food_stamps_recipients_rnk * input$wt_food_stamps_recipients,
          weighted_renter_households = renter_households_rnk * input$wt_renter_households,
          weighted_unemployed_persons = unemployed_persons_rnk * input$wt_unemployed_persons,
          weighted_cost_burdened_renters_35_percent = cost_burdened_renters_35_percent_rnk * input$wt_cost_burdened_renters_35_percent,
          weighted_cost_burdened_owners_with_mortgage_35_percent = cost_burdened_owners_with_mortgage_35_percent_rnk * input$wt_cost_burdened_owners_with_mortgage_35_percent,
          weighted_insufficient_commuter_vehicles = insufficient_commuter_vehicles_rnk * input$wt_insufficient_commuter_vehicles,
          weighted_persons_with_disabilities = persons_with_disabilities_rnk * input$wt_persons_with_disabilities,
          weighted_adults_without_4_yr_degree = adults_without_4_yr_degree_rnk * input$wt_adults_without_4_yr_degree,
          weighted_students_k_12 = students_k_12_rnk * input$wt_students_k_12,
          weighted_retirees_65 = retirees_65_rnk * input$wt_retirees_65,
          weighted_overcrowded_households = overcrowded_households_rnk * input$wt_overcrowded_households,
          weighted_no_computer_access = no_computer_access_rnk * input$wt_no_computer_access,
          weighted_no_broadband_access = no_broadband_access_rnk * input$wt_no_broadband_access,
          
          composite_score = weighted_people_of_color + weighted_black_native_and_latinx_people + 
            weighted_households_with_limited_english + weighted_median_household_income + 
            weighted_food_stamps_recipients + weighted_renter_households + weighted_commuters +
            weighted_unemployed_persons + weighted_cost_burdened_renters_35_percent + 
            weighted_cost_burdened_owners_with_mortgage_35_percent + 
            weighted_insufficient_commuter_vehicles + weighted_persons_with_disabilities + 
            weighted_adults_without_4_yr_degree + weighted_students_k_12 + weighted_retirees_65 + 
            weighted_overcrowded_households + weighted_no_computer_access + weighted_no_broadband_access,# + weighted_user_data,
          
          indexed_score = round(range01(composite_score, na.rm = T) * 100, 0)) %>%
        arrange(desc(indexed_score))
    }
    reweighted_data
  })
  
  output$download_geojson <- downloadHandler(
    filename = "custom_weight_export-geojson.geojson",
    content = function(file) {
      sf::st_write(obj = reweighted(), dsn = file)
    }
  )  
  
  output$download_basedata <- downloadHandler(
    filename = "base_demographic_data.xlsx",
    content = function(file) {
      datalist <- list("data" = st_drop_geometry(filtered_vulnerability_data()), "labels" = base_data_labels)
      rio::export(datalist, file = file)
    }
  )
  
  
  
  bins <- c(0, 20, 40, 60, 80, 100)
  pal <- leaflet::colorBin(viridis_pal(option = "C")(length(bins)), bins = bins)
  
  output$vulnerabilitymap <- renderLeaflet({
    leaflet() %>%
      addProviderTiles('CartoDB.Positron') %>%
      setView(lng = -97.745, lat = 30.262, zoom = 11) %>% 
      addLegend("topright", pal = pal,
                values = bins,
                title = "Vulnerability Index",
                opacity = 0.6)
  })
  
  ## https://stackoverflow.com/questions/46186014/changing-leaflet-map-according-to-input-without-redrawing-multiple-polygons
  observe({
    popup_context <- paste0("<strong>Tract: </strong>", reweighted()$NAME,
                            "<br/><strong>Vulnerability Score: </strong>", scales::comma(reweighted()$indexed_score, accuracy = 1),
                            "<br/><strong>People of Color: </strong>", scales::percent(reweighted()$people_of_color, accuracy = 1.1),
                            "<br/><strong>Black, Indigenous, Latinx: </strong>", scales::percent(reweighted()$black_native_and_latinx_people, accuracy = 1.1),
                            "<br/><strong>Commuters: </strong>", scales::percent(reweighted()$commuters, accuracy = 1.1),
                            "<br/><strong>Unemployed persons: </strong>", scales::percent(reweighted()$unemployed_persons, accuracy = 1.1),
                            "<br/><strong>Insufficient commuter vehicles: </strong>", scales::percent(reweighted()$insufficient_commuter_vehicles, accuracy = 1.1),
                            "<br/><strong>Persons with disabilities: </strong>", scales::percent(reweighted()$persons_with_disabilities, accuracy = 1.1),
                            "<br/><strong>Households with limited English: </strong>", scales::percent(reweighted()$households_with_limited_english, accuracy = 1.1),
                            "<br/><strong>Adults without 4-yr degree: </strong>", scales::percent(reweighted()$adults_without_4_yr_degree, accuracy = 1.1),
                            "<br/><strong>Students (K-12): </strong>", scales::percent(reweighted()$students_k_12, accuracy = 1.1),
                            "<br/><strong>Retirees (65+): </strong>", scales::percent(reweighted()$retirees_65, accuracy = 1.1),
                            "<br/><strong>Median household income: </strong>", scales::dollar(reweighted()$median_household_income, accuracy = 1),
                            "<br/><strong>Food stamp recipients: </strong>", scales::percent(reweighted()$food_stamps_recipients, accuracy = 1.1),
                            "<br/><strong>Renter households: </strong>", scales::percent(reweighted()$renter_households, accuracy = 1.1),
                            "<br/><strong>Cost-burdened renters: </strong>", scales::percent(reweighted()$cost_burdened_renters_35_percent, accuracy = 1.1),
                            "<br/><strong>Cost-burdened w mortgage: </strong>", scales::percent(reweighted()$cost_burdened_owners_with_mortgage_35_percent, accuracy = 1.1),
                            "<br/><strong>Overcrowded households: </strong>", scales::percent(reweighted()$overcrowded_households, accuracy = 1.1),
                            "<br/><strong>No computer access: </strong>", scales::percent(reweighted()$no_computer_access, accuracy = 1.1),
                            "<br/><strong>No broadband access: </strong>", scales::percent(reweighted()$no_broadband_access, accuracy = 1.1))
    
    proxy <- leafletProxy("vulnerabilitymap", data = reweighted())
    
    proxy %>% clearShapes() %>%
      addPolygons(
        fillColor = ~pal(indexed_score),
        weight = 1,
        opacity = 1,
        color = "white",
        dashArray = "3",
        popup = popup_context,
        fillOpacity = 0.5) %>%
      addPolylines(
        data = usb,
        weight = 2,
        opacity = 0.5,
        fillOpacity = 0,
        color = "#FF0000",
        group = "City of Austin Boundary") %>%
      ## Toggle group layers: https://rstudio.github.io/leaflet/showhide.html
      addLayersControl(
        overlayGroups = c("City of Austin Boundary"),
        options = layersControlOptions(collapsed = FALSE)
      ) 
    
  })
  
  
  
    output$resultsTable <- renderDataTable({

      reweighted() %>%
        arrange(desc(indexed_score)) %>%
        st_drop_geometry() %>%
        select(GEOID,
               `Vulnerability Score` = indexed_score,
               `% POC` = people_of_color,
               `% BIPOC` = black_native_and_latinx_people,
               `% Commuters` = commuters,
               `% Unemp` = unemployed_persons,
               `% Insuff. Veh.` = insufficient_commuter_vehicles,
               `% Disabled` = persons_with_disabilities,
               `% LEP` = households_with_limited_english,
               `% < 4yr Deg.` = adults_without_4_yr_degree,
               `% Students` = students_k_12,
               `% Retirees` = retirees_65,
               `% Food Stamps` = food_stamps_recipients,
               `% Renters` = renter_households,
               `% Cost-burden Renters` = cost_burdened_renters_35_percent,
               `% Cost-burden Mortgage` = cost_burdened_owners_with_mortgage_35_percent,
               `% Overcrowded` = overcrowded_households,
               `% No Computer` = no_computer_access,
               `% No Broadband` = no_broadband_access,
               `Med. HH Income` = median_household_income,
        ) %>%
        mutate(across(c(`% POC`:`% No Broadband`), 
                      ~scales::percent(round(., digits = 2), accuracy = 0.1)),
               `Med. HH Income` = scales::dollar(`Med. HH Income`))
    },

    # Use autoWidth and scrollX to overflow many columns problem for table modal popup
    # https://stackoverflow.com/questions/34850382/setting-column-width-in-r-shiny-datatable-does-not-work-in-case-of-lots-of-colum
    options = list(pageLength=10, autoWidth = TRUE, scrollX = TRUE))

}


# Run the application 
# options(browser = "/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary")
# runApp(list(ui = ui, server = server, display.mode = "showcase"), host = "127.0.0.1", port = 7002, launch.browser = T) # 192.168.1.170 # 127.0.0.1
shinyApp(ui = ui, server = server)
