setwd("~/projects/repos/vulnerability_weighting_map/")
source("GLOBAL.R")

# file.copy("1_data/3_processed/acs_vuln_weighting_data.rds",
#           to = "5_apps/weighting_tool/",
#           overwrite = TRUE)

wide_data <- readRDS("1_data/3_processed/acs_vuln_weighting_data.rds") %>%
  st_transform(WEB_EPSG) %>%
  rmapshaper::ms_simplify(., keep = 0.5) 

PRIMARY_PLACE %>%
  st_transform(WEB_EPSG) %>%
  rmapshaper::ms_simplify(., keep = 0.3) %>% 
  saveRDS("5_apps/weighting_tool/primary_place_outline.rds")


## Use a linear model to impute median household income based off race and education
# create model object
mhi.fit <- lm(median_household_income ~ black_native_and_latinx_people + adults_without_4_yr_degree, 
              data = wide_data)

# see model fit... it's a good fit
summary(mhi.fit)

# take a subset
working <- wide_data %>%
  st_drop_geometry() %>%
  select(GEOID, median_household_income, black_native_and_latinx_people, adults_without_4_yr_degree) 

# select those without data to predict income
nodat <- working[!complete.cases(working), ] %>%
  filter(GEOID != "48453980000")

# predict income
nodat$median_household_income <- predict.lm(mhi.fit, newdata = nodat)
nodat <- select(nodat, GEOID, median_household_income)

income_with_imputations <- wide_data %>%
  st_drop_geometry() %>%
  select(GEOID, median_household_income) %>%
  filter(!(GEOID %in% nodat$GEOID)) %>%
  rbind(., nodat)

final_data <- wide_data %>%
  select(-median_household_income) %>%
  left_join(., income_with_imputations, by = "GEOID") %>%
  select(names(wide_data))

saveRDS(final_data, "5_apps/weighting_tool/acs_vuln_weighting_data.rds")
