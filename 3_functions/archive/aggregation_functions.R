aggregate_long <- function(df, vars2collapse, ...) {
  group_var <- enquos(...)
  
  df %>% 
    filter(variable %in% vars2collapse) %>%
    group_by(!!! group_var) %>% 
    summarize(est = sum(estimate),
              moe = moe_sum(moe, estimate))
}

aggregate_long_varnum <- function(df, varnums2collapse, ...) {
  group_var <- enquos(...)
  
  df %>% 
    filter(varnum %in% varnums2collapse) %>%
    group_by(!!! group_var) %>% 
    summarize(est = sum(estimate),
              moe = moe_sum(moe, estimate))
}

make_summary_var <- function(df) {
  df %>% filter(variable == "Total") %>% rename(summary_est = est, summary_moe = moe) %>% select(GEOID, year, subgroup, summary_est, summary_moe)
}

add_pct <- function(aggd_df) {
  ret <- aggd_df %>%
    left_join(., make_summary_var(aggd_df), by = c('GEOID', 'year', 'subgroup')) %>%
    group_by(GEOID, year, variable) %>%
    mutate(pct_est = est / summary_est,
           pct_moe = moe_prop(est, summary_est, moe, summary_moe),
           parameter = "Percent") %>%
    select(GEOID, year, parameter, subgroup, variable, est = pct_est, moe = pct_moe, universe, topic) %>% ungroup() %>%
    rbind(., aggd_df) %>% ungroup() 
}