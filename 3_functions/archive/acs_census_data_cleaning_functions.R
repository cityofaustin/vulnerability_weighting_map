var2race <- function(raw_variable) {
  ret <- case_when(substr(raw_variable, 7, 7) == "_" ~ "All",
                   substr(raw_variable, 7, 7) == "A" ~ "White, not Hispanic",
                   substr(raw_variable, 7, 7) == "B" ~ "Black, not Hispanic",
                   substr(raw_variable, 7, 7) == "C" ~ "Native American, not Hispanic",
                   substr(raw_variable, 7, 7) == "D" ~ "Asian, not Hispanic",
                   substr(raw_variable, 7, 7) == "E" ~ "Hawaiian or Pacific Islander, not Hispanic",
                   substr(raw_variable, 7, 7) == "F" ~ "Another race, not Hispanic",
                   substr(raw_variable, 7, 7) == "G" ~ "Two or more races, not Hispanic",
                   substr(raw_variable, 7, 7) == "H" ~ "White alone, not Hispanic",
                   substr(raw_variable, 7, 7) == "I" ~ "Hispanic or Latino",
                   TRUE ~ NA_character_)
  return(ret)
}

## Return pareto median from interval data, such as age, income or gross rent
grouped_median <- function(df, freq_col, interval_col, sep = NULL, trim = NULL) {
  
  # Modified from: # https://github.com/mrdwab/SOfun/raw/master/R/GroupedMedian.R
  # found via: https://stackoverflow.com/questions/18887382/how-to-calculate-the-median-on-grouped-dataset/18931054#18931054
  
  ## Separate based on interval column so that we can arrange high to low based on ranges
  df <- df %>% 
    separate(!!interval_col, c("i1", "i2"), sep = sep) %>% 
    mutate_at(vars(i1, i2), as.numeric) %>% arrange(i1) %>%
    mutate(interval = paste0(i1, sep, i2))
  
  intervals <- df %>% pull(interval)
  frequencies <- df %>% pull(!!freq_col)
  
  if (!is.null(sep)) {
    if (is.null(trim)) pattern <- ""
    else if (trim == "cut") pattern <- "\\[|\\]|\\(|\\)"
    else pattern <- trim
    intervals <- sapply(strsplit(gsub(pattern, "", intervals), sep), as.numeric)
  }
  
  Midpoints <- rowMeans(intervals)
  cf <- cumsum(frequencies)
  Midrow <- findInterval(max(cf)/2, cf) + 1
  L <- intervals[1, Midrow]
  h <- diff(intervals[, Midrow])
  f <- frequencies[Midrow]
  cf2 <- cf[Midrow - 1]
  n_2 <- max(cf)/2
  
  unname(L + (n_2 - cf2)/f * h)
  
}


aggregate_long <- function(df, vars2collapse, ...) {
  group_var <- enquos(...)
  
  df %>% 
    filter(variable %in% vars2collapse) %>%
    group_by(!!! group_var) %>% 
    summarize(est = sum(estimate),
              moe = moe_sum(moe, estimate))
}

aggregate_long_varnum <- function(df, varnums2collapse, ...) {
  group_var <- enquos(...)
  
  df %>% 
    filter(varnum %in% varnums2collapse) %>%
    group_by(!!! group_var) %>% 
    summarize(est = sum(estimate),
              moe = moe_sum(moe, estimate))
}

make_summary_var <- function(df, total_var = "Total") {
  df %>% filter(variable == total_var) %>% 
    rename(summary_est = est, summary_moe = moe) %>% 
    select(GEOID, year, subgroup, table, sumlevel, summary_est, summary_moe)
}

add_pct <- function(aggd_df, total_var = "Total") {
  ret <- aggd_df %>%
    left_join(., make_summary_var(aggd_df, total_var = total_var), by = c('GEOID', 'year', 'subgroup', 'table', 'sumlevel')) %>%
    group_by(GEOID, year, variable, table, sumlevel) %>%
    mutate(pct_est = est / summary_est,
           pct_moe = moe_prop(est, summary_est, moe, summary_moe),
           parameter = "Percent") %>%
    select(GEOID, year, parameter, subgroup, variable, est = pct_est, moe = pct_moe, universe, topic) %>% ungroup() %>%
    rbind(., aggd_df) %>% ungroup() %>%
    mutate(summary_variable = total_var) %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, summary_variable, universe, topic, table, sumlevel) %>%
    arrange(GEOID, year, variable)
}

aggregate_age <- function(df) {
  age <- df %>%
    filter(table == 'B01001',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  age_aggd <- rbind(
    age %>% aggregate_long_varnum(., varnums2collapse = c(3:6, 27:30), GEOID, year, table, sumlevel) %>% mutate(variable = "Youth <18", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(3, 4, 27, 28), GEOID, year, table, sumlevel) %>% mutate(variable = "Youth <10", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(7:19, 31:43), GEOID, year, table, sumlevel) %>% mutate(variable = "Age 18 to 64", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(13:16, 37:40), GEOID, year, table, sumlevel) %>% mutate(variable = "Age 35 to 54", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(20:25, 44:49), GEOID, year, table, sumlevel) %>% mutate(variable = "Elders 64+", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(23:25, 47:49), GEOID, year, table, sumlevel) %>% mutate(variable = "Elders 74+", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    
    age %>% aggregate_long_varnum(., varnums2collapse = c(3:6), GEOID, year, table, sumlevel) %>% mutate(variable = "Youth <18", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(3, 4), GEOID, year, table, sumlevel) %>% mutate(variable = "Youth <10", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(7:19), GEOID, year, table, sumlevel) %>% mutate(variable = "Age 18 to 64", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(13:16), GEOID, year, table, sumlevel) %>% mutate(variable = "Age 35 to 54", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(20:25), GEOID, year, table, sumlevel) %>% mutate(variable = "Elders 64+", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(23:25), GEOID, year, table, sumlevel) %>% mutate(variable = "Elders 74+", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    
    age %>% aggregate_long_varnum(., varnums2collapse = c(27:30), GEOID, year, table, sumlevel) %>% mutate(variable = "Youth <18", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(27, 28), GEOID, year, table, sumlevel) %>% mutate(variable = "Youth <10", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(31:43), GEOID, year, table, sumlevel) %>% mutate(variable = "Age 18 to 64", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(37:40), GEOID, year, table, sumlevel) %>% mutate(variable = "Age 35 to 54", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(44:49), GEOID, year, table, sumlevel) %>% mutate(variable = "Elders 64+", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(47:49), GEOID, year, table, sumlevel) %>% mutate(variable = "Elders 74+", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age"),
    
    age %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population", subgroup = "Male", universe = "Total Population", parameter = "Total", topic = "Age"),
    age %>% aggregate_long_varnum(., varnums2collapse = c(26), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population", subgroup = "Female", universe = "Total Population", parameter = "Total", topic = "Age")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population") %>%
    filter(!(parameter == "Percent" & variable == "Total population"))
  
  return(age_aggd)
}




aggregate_education <- function(df){
  education <- df %>%
    filter(table %in% c('B15002', 'SF3_P037'),
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  edu_aggd<- rbind(
    education %>% aggregate_long_varnum(., varnums2collapse = c(3:14, 20:31), GEOID, year, table, sumlevel) %>% mutate(variable = "No four-year degree", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(15:18, 32:35), GEOID, year, table, sumlevel) %>% mutate(variable = "Bachelor's or higher", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population 25+", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    
    education %>% aggregate_long_varnum(., varnums2collapse = c(3:14), GEOID, year, table, sumlevel) %>% mutate(variable = "No four-year degree", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(15:18), GEOID, year, table, sumlevel) %>% mutate(variable = "Bachelor's or higher", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population 25+", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    
    education %>% aggregate_long_varnum(., varnums2collapse = c(20:31), GEOID, year, table, sumlevel) %>% mutate(variable = "No four-year degree", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(32:35), GEOID, year, table, sumlevel) %>% mutate(variable = "Bachelor's or higher", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(19), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population 25+", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    
    
    education %>% aggregate_long_varnum(., varnums2collapse = c(3:10, 20:27), GEOID, year, table, sumlevel) %>% mutate(variable = "Less than HS diploma", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(11, 28), GEOID, year, table, sumlevel) %>% mutate(variable = "HS diploma", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(12:14, 29:31), GEOID, year, table, sumlevel) %>% mutate(variable = "Some college or Associate's degree", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(15, 32), GEOID, year, table, sumlevel) %>% mutate(variable = "Bachelor's degree", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(16:18, 33:35), GEOID, year, table, sumlevel) %>% mutate(variable = "Master's degree or higher", subgroup = "All", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    
    education %>% aggregate_long_varnum(., varnums2collapse = c(3:10), GEOID, year, table, sumlevel) %>% mutate(variable = "Less than HS diploma", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(11), GEOID, year, table, sumlevel) %>% mutate(variable = "HS diploma", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(12:14), GEOID, year, table, sumlevel) %>% mutate(variable = "Some college or Associate's degree", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(15), GEOID, year, table, sumlevel) %>% mutate(variable = "Bachelor's degree", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(16:18), GEOID, year, table, sumlevel) %>% mutate(variable = "Master's degree or higher", subgroup = "Male", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    
    education %>% aggregate_long_varnum(., varnums2collapse = c(20:27), GEOID, year, table, sumlevel) %>% mutate(variable = "Less than HS diploma", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(28), GEOID, year, table, sumlevel) %>% mutate(variable = "HS diploma", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(29:31), GEOID, year, table, sumlevel) %>% mutate(variable = "Some college or Associate's degree", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(32), GEOID, year, table, sumlevel) %>% mutate(variable = "Bachelor's degree", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(33:35), GEOID, year, table, sumlevel) %>% mutate(variable = "Master's degree or higher", subgroup = "Female", universe = "Population 25 Years and Over", parameter = "Total", topic = "Educational Attainment")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population 25+") %>%
    filter(!(parameter == "Percent" & variable == "Total population 25+"))
}


aggregate_education_race <- function(df){
  education <- df %>%
    filter(substr(table, 1, 6) == 'C15002',
           # str_detect(table, 'C15002'),
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) %>%
    mutate(subgroup = var2race(variable))
  
  edu_aggd<- rbind(
    education %>% aggregate_long_varnum(., varnums2collapse = c(3, 8), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Less than HS diploma", universe = paste0(subgroup, " Population 25 Years and Over"), parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(4, 9), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "HS diploma", universe = paste0(subgroup, " Population 25 Years and Over"), parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(5, 10), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Some college or Associate's degree", universe = paste0(subgroup, " Population 25 Years and Over"), parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(6, 11), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Bachelor's or higher", universe = paste0(subgroup, " Population 25 Years and Over"), parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(3:5, 8:10), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "No four-year degree", universe = paste0(subgroup, " Population 25 Years and Over"), parameter = "Total", topic = "Educational Attainment"),
    education %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Total population 25+", universe = paste0(subgroup, " Population 25 Years and Over"), parameter = "Total", topic = "Educational Attainment")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population 25+") %>%
    filter(!(parameter == "Percent" & variable == "Total population 25+"))
}

aggregate_education_race_extract_bipoc <- function(edu_full_aggregated, edu_race_aggregated){
  
  tmp0 <- rbind(edu_full_aggregated, edu_race_aggregated)
  
  tmp2 <- edu_race_aggregated %>%
    filter(parameter == "Total", subgroup == "White alone, not Hispanic") %>%
    select(GEOID, year, variable, whest = est, whmoe = moe,  table, sumlevel)
  
  slim_edu_vars <- tmp2 %>% pull(variable) %>% unique()
  
  tmp1 <- edu_full_aggregated %>%
    filter(parameter == "Total", subgroup == "All", 
           variable %in% slim_edu_vars) %>%
    select(GEOID, year, variable, sumest = est, summoe = moe,  table, sumlevel)
  
  edu_final <- left_join(tmp1, tmp2, by = c("GEOID", "year", "variable", "sumlevel")) %>%
    mutate(est = sumest - whest,
           moe = sqrt(whmoe^2 + summoe^2), ## MOE for subtracted variables same as adding https://www.census.gov/content/dam/Census/programs-surveys/acs/guidance/training-presentations/20170419_MOE_Transcript.pdf
           subgroup = "People of Color", 
           universe = "People of Color Population 25 Years and Over", 
           parameter = "Total", 
           topic = "Educational Attainment", 
           parameter = "Total", 
           table = "C15002") %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, universe, topic, table, sumlevel) %>%
    add_pct(., total_var = "Total population 25+") %>%
    filter(!(parameter == "Percent" & variable == "Total")) %>%
    arrange(GEOID, year, variable)
}


aggregate_tenure <- function(df){
  tenure <- df %>%
    filter(table %in% c('B25003', 'SF1_H004'),
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  ten_aggd <- rbind(
    tenure %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "Renters", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Tenure"),
    tenure %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Owners", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Tenure"),
    tenure %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Tenure")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}


aggregate_race <- function(df){
  race <- df %>%
    filter(table == 'B03002',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  race_aggd <- rbind(
    race %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "White alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(4), GEOID, year, table, sumlevel) %>% mutate(variable = "Black alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(5), GEOID, year, table, sumlevel) %>% mutate(variable = "Native American alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(6), GEOID, year, table, sumlevel) %>% mutate(variable = "Asian alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(7), GEOID, year, table, sumlevel) %>% mutate(variable = "Hawaiian or Pacific Islander alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Another race alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(9), GEOID, year, table, sumlevel) %>% mutate(variable = "Two or more races, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(12), GEOID, year, table, sumlevel) %>% mutate(variable = "Hispanic or Latino", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(4, 5, 7, 12), GEOID, year, table, sumlevel) %>% mutate(variable = "Black, Indigenous, Latinx", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(4, 5, 6, 7, 8, 9, 12), GEOID, year, table, sumlevel) %>% mutate(variable = "People of Color", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population") %>%
    filter(!(parameter == "Percent" & variable == "Total population"))
}


aggregate_stock_age <- function(df){
  stock_age <- df %>%
    filter(table == 'B25037',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  stock_aggd <- rbind(
    stock_age %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "Median Age of Housing Stock", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Age of Housing Stock"),
    stock_age %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Median Age of Housing Stock", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Age of Housing Stock"),
    stock_age %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Median Age of Housing Stock", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Age of Housing Stock")
  ) %>% ungroup() %>%
    mutate(summary_variable = NA_character_) %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, summary_variable, universe, topic, table, sumlevel) %>%
    arrange(GEOID, year, variable) %>%
    filter(!(parameter == "Percent" & variable == "Total"))
}

aggregate_poverty <- function(df){
  poverty <- df %>%
    filter(table == 'C17002',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  pov_aggd <- rbind(
    poverty %>% aggregate_long_varnum(., varnums2collapse = c(2,3), GEOID, year, table, sumlevel) %>% mutate(variable = "Income Under 1x Poverty", subgroup = "All", universe = "Population for Whom Poverty Status Is Determined", parameter = "Total", topic = "Poverty"),
    poverty %>% aggregate_long_varnum(., varnums2collapse = c(4:8), GEOID, year, table, sumlevel) %>% mutate(variable = "Income Over 1x Poverty", subgroup = "All", universe = "Population for Whom Poverty Status Is Determined", parameter = "Total", topic = "Poverty"),
    poverty %>% aggregate_long_varnum(., varnums2collapse = c(2:7), GEOID, year, table, sumlevel) %>% mutate(variable = "Income Under 2x Poverty", subgroup = "All", universe = "Population for Whom Poverty Status Is Determined", parameter = "Total", topic = "Poverty"),
    poverty %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Income Over 2x Poverty", subgroup = "All", universe = "Population for Whom Poverty Status Is Determined", parameter = "Total", topic = "Poverty"),
    poverty %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population for whom poverty is determined", subgroup = "All", universe = "Population for Whom Poverty Status Is Determined", parameter = "Total", topic = "Poverty")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population for whom poverty is determined") %>%
    filter(!(parameter == "Percent" & variable == "Total population for whom poverty is determined"))
}


aggregate_cost_burden <- function(df){
  hcb <- df %>%
    filter(table == 'B25106',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  hcb_aggd <- rbind(
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(6, 10, 14, 18, 22, 28, 32, 36, 40, 44), GEOID, year, table, sumlevel) %>% mutate(variable = "Housing cost burdened (>30%)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(4,8,12,16,20,26,30,34,38,42,5,9,13,17,21,27,31,35,39,43), GEOID, year, table, sumlevel) %>% mutate(variable = "Not housing cost burdened (<30%)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(28, 32, 36, 40, 44), GEOID, year, table, sumlevel) %>% mutate(variable = "Housing cost burdened (>30%)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(6, 10, 14, 18, 22), GEOID, year, table, sumlevel) %>% mutate(variable = "Housing cost burdened (>30%)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(27, 31, 35, 39, 43, 26,30,34,38,42), GEOID, year, table, sumlevel) %>% mutate(variable = "Not housing cost burdened (<30%)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(5, 9, 13, 17, 21, 4,8,12,16,20), GEOID, year, table, sumlevel) %>% mutate(variable = "Not housing cost burdened (<30%)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(24), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost"),
    hcb %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Housing Cost")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}


aggregate_single_parents <- function(df){
  single_parents <- df %>%
    filter(table == 'B11003',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  moms_aggd <- rbind(
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "Married couple with own kids < 18", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(4), GEOID, year, table, sumlevel) %>% mutate(variable = "Married couple with own kids < 6", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(16), GEOID, year, table, sumlevel) %>% mutate(variable = "Single mother with own kids < 18", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(17), GEOID, year, table, sumlevel) %>% mutate(variable = "Single mother with own kids < 6", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(10), GEOID, year, table, sumlevel) %>% mutate(variable = "Single father with own kids < 18", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(11), GEOID, year, table, sumlevel) %>% mutate(variable = "Single father with own kids < 6", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(16, 10), GEOID, year, table, sumlevel) %>% mutate(variable = "Single parents with own kids < 18", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(11, 17), GEOID, year, table, sumlevel) %>% mutate(variable = "Single parents with own kids < 6", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households"),
    
    single_parents %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total families", subgroup = "All", universe = "Families", parameter = "Total", topic = "Families & Households")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total families") %>%
    filter(!(parameter == "Percent" & variable == "Total families"))
}



aggregate_hhtype <- function(df){
  hhtype <- df %>%
    filter(table == 'B11001',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  hhtype_aggd <- rbind(
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total family households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "Married couple family households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(4), GEOID, year, table, sumlevel) %>% mutate(variable = "Other family type family households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(7), GEOID, year, table, sumlevel) %>% mutate(variable = "Total non-family households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Living alone non-family households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(9), GEOID, year, table, sumlevel) %>% mutate(variable = "Not living alone non-family households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhtype %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}



aggregate_ten_unitsstr <- function(df){
  ten_by_unitsstr2 <- df %>%
    filter(table == 'B25032',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  tenunts <- rbind(
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(3, 4), GEOID, year, table, sumlevel) %>% mutate(variable = "Single-family (attached, detached)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(5:10), GEOID, year, table, sumlevel) %>% mutate(variable = "Multi-family (2+ units)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "Detached single-family", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(4:6), GEOID, year, table, sumlevel) %>% mutate(variable = "Middle housing (up to 4 units)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(7), GEOID, year, table, sumlevel) %>% mutate(variable = "Neighborhood multi-family (5-9 units)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Small multi-family (10-19 units)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(9), GEOID, year, table, sumlevel) %>% mutate(variable = "Medium multi-family (20-49 units)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(10), GEOID, year, table, sumlevel) %>% mutate(variable = "Large multi-family (50+ units)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(11, 12), GEOID, year, table, sumlevel) %>% mutate(variable = "Other (mobile home, boat, RV, van)", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total housing units", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    
    
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(14, 15), GEOID, year, table, sumlevel) %>% mutate(variable = "Single-family (attached, detached)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(16:21), GEOID, year, table, sumlevel) %>% mutate(variable = "Multi-family (2+ units)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(14), GEOID, year, table, sumlevel) %>% mutate(variable = "Detached single-family", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(15:17), GEOID, year, table, sumlevel) %>% mutate(variable = "Middle housing (up to 4 units)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(18), GEOID, year, table, sumlevel) %>% mutate(variable = "Neighborhood multi-family (5-9 units)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(19), GEOID, year, table, sumlevel) %>% mutate(variable = "Small multi-family (10-19 units)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(20), GEOID, year, table, sumlevel) %>% mutate(variable = "Medium multi-family (20-49 units)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(21), GEOID, year, table, sumlevel) %>% mutate(variable = "Large multi-family (50+ units)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(22, 23), GEOID, year, table, sumlevel) %>% mutate(variable = "Other (mobile home, boat, RV, van)", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(13), GEOID, year, table, sumlevel) %>% mutate(variable = "Total housing units", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    
    
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(3, 4, 14, 15), GEOID, year, table, sumlevel) %>% mutate(variable = "Single-family (attached, detached)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(5:10, 16:21), GEOID, year, table, sumlevel) %>% mutate(variable = "Multi-family (2+ units)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(3, 14), GEOID, year, table, sumlevel) %>% mutate(variable = "Detached single-family", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(4:6, 15:17), GEOID, year, table, sumlevel) %>% mutate(variable = "Middle housing (up to 4 units)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(7, 18), GEOID, year, table, sumlevel) %>% mutate(variable = "Neighborhood multi-family (5-9 units)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(8, 19), GEOID, year, table, sumlevel) %>% mutate(variable = "Small multi-family (10-19 units)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(9, 20), GEOID, year, table, sumlevel) %>% mutate(variable = "Medium multi-family (20-49 units)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(10, 21), GEOID, year, table, sumlevel) %>% mutate(variable = "Large multi-family (50+ units)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(11, 12, 22, 23), GEOID, year, table, sumlevel) %>% mutate(variable = "Other (mobile home, boat, RV, van)", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure"),
    
    ten_by_unitsstr2 %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total housing units", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Units in Structure")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total housing units") %>%
    filter(!(parameter == "Percent" & variable == "Total housing units"))
}


aggregate_foodstamps <- function(df){
  foodstamps <- df %>%
    filter(table == 'B22001',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  foodstamps_aggd <- rbind(
    foodstamps %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Food stamps received in last 12 months", subgroup = "All", universe = "Households", parameter = "Total", topic = "Food Stamps/SNAP"),
    foodstamps %>% aggregate_long_varnum(., varnums2collapse = c(5), GEOID, year, table, sumlevel) %>% mutate(variable = "No food stamps received in last 12 months", subgroup = "All", universe = "Households", parameter = "Total", topic = "Food Stamps/SNAP"),
    foodstamps %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Food Stamps/SNAP")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}


aggregate_gross_rent <- function(df, cpi = cpi, inflation_factor = "inflation_factor_2019"){
  mgr <- df %>%
    filter(table %in% c('B25064', 'SF3_H063'),
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) %>%
    left_join(., cpi, by = "year") %>%
    mutate(subgroup = "All",
           est = estimate * !!sym(inflation_factor),
           moe = moe * !!sym(inflation_factor),
           variable = "Median gross rent", universe = "Renter-Occupied Households", parameter = "Total", topic = "Housing Cost") %>%
    mutate(summary_variable = NA_character_) %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, summary_variable, universe, topic, table, sumlevel) %>%
    arrange(GEOID, year, variable, subgroup) %>%
    filter(!(parameter == "Percent" & variable == "Total"))
}


aggregate_owner_costs <- function(df, cpi = cpi, inflation_factor = "inflation_factor_2019"){
  owncost <- df %>%
    filter(table == 'B25088',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) %>%
    left_join(., cpi, by = "year") %>%
    mutate(est = estimate * !!sym(inflation_factor),
           moe = moe * !!sym(inflation_factor)) 
  
  owncost_aggd <- rbind(
    owncost %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(subgroup = "All", variable = "Median monthly owner costs", universe = "Owner-Occupied Households", parameter = "Total", topic = "Housing Cost"),
    owncost %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(subgroup = "With mortgage", variable = "Median monthly owner costs", universe = "Owner-Occupied Households", parameter = "Total", topic = "Housing Cost"),
    owncost %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(subgroup = "Own free-and-clear", variable = "Median monthly owner costs", universe = "Owner-Occupied Households", parameter = "Total", topic = "Housing Cost")
  ) %>% ungroup() %>%
    mutate(summary_variable = NA_character_) %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, summary_variable, universe, topic, table, sumlevel) %>%
    arrange(GEOID, year, variable, subgroup) %>%
    filter(!(parameter == "Percent" & variable == "Total"))
}


aggregate_hhsize <- function(df){
  hhsize <- df %>%
    filter(table == 'B25010',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  hhsize_aggd <- rbind(
    hhsize %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Average household size", subgroup = "All", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhsize %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Average household size", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "Families & Households"),
    hhsize %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "Average household size", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "Families & Households")
  ) %>% ungroup() %>%
    mutate(summary_variable = NA_character_) %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, summary_variable, universe, topic, table, sumlevel) %>%
    arrange(GEOID, year, variable) %>%
    filter(!(parameter == "Percent" & variable == "Total"))
}


aggregate_ppr <- function(df){
  persons_per_room <- df %>%
    filter(table == 'B25014',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  ppr_aggd <- rbind(
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(3,4, 9,10), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: Less than 1", subgroup = "All", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(5,6, 11,12), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: Between 1 and 2", subgroup = "All", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(7, 13), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: More than 2 ", subgroup = "All", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(5,6,7, 11,12,13), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: More than 1", subgroup = "All", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(3,4), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: Less than 1", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(5,6), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: Between 1 and 2", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(7), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: More than 2 ", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(5,6,7), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: More than 1", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(9,10), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: Less than 1", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(11,12), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: Between 1 and 2", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(13), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: More than 2 ", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(11,12,13), GEOID, year, table, sumlevel) %>% mutate(variable = "People per room: More than 1", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "People Per Rooom"),
    persons_per_room %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "People Per Rooom")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}


aggregate_overcrowding <- function(df){
  ## See https://www.census.gov/content/dam/Census/programs-surveys/ahs/publications/Measuring_Overcrowding_in_Hsg.pdf
  overcrowding <- df %>%
    filter(table == 'B25014',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  overcrowding_aggd <- rbind(
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(3,4, 9,10), GEOID, year, table, sumlevel) %>% mutate(variable = "Not overcrowded (PPR < 1.0)", subgroup = "All", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(5,6,7, 11,12,13), GEOID, year, table, sumlevel) %>% mutate(variable = "Overcrowded (PPR > 1.0)", subgroup = "All", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(3,4), GEOID, year, table, sumlevel) %>% mutate(variable = "Not overcrowded (PPR < 1.0)", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(5,6,7), GEOID, year, table, sumlevel) %>% mutate(variable = "Overcrowded (PPR > 1.0)", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Owners", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(9,10), GEOID, year, table, sumlevel) %>% mutate(variable = "Not overcrowded (PPR < 1.0)", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(11,12,13), GEOID, year, table, sumlevel) %>% mutate(variable = "Overcrowded (PPR > 1.0)", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Renters", universe = "Households", parameter = "Total", topic = "Overcrowding"),
    
    overcrowding %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Overcrowding")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}

aggregate_modesplit <- function(df){
  modesplit <- df %>%
    filter(table == 'B08006',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  modesplit_aggd <- rbind(
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "SOV (drive alone)", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(4,8,14:17), GEOID, year, table, sumlevel) %>% mutate(variable = "Non-SOV (carpool, transit, etc.)", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Public transit", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(14,15), GEOID, year, table, sumlevel) %>% mutate(variable = "Active transport (bike or walk)", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(14), GEOID, year, table, sumlevel) %>% mutate(variable = "Bicycle", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(15), GEOID, year, table, sumlevel) %>% mutate(variable = "Walk", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(16), GEOID, year, table, sumlevel) %>% mutate(variable = "Taxi, motorcycle, other", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(17), GEOID, year, table, sumlevel) %>% mutate(variable = "Work from home", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice"),
    modesplit %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total workers", subgroup = "All", universe = "Workers 16 Years and Over", parameter = "Total", topic = "Commute Mode Choice")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total workers") %>%
    filter(!(parameter == "Percent" & variable == "Total workers"))
}

aggregate_vehicles_available <- function(df){
  vehicles <- df %>%
    filter(table == 'B25044',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  modesplit_aggd <- rbind(
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(3,10), GEOID, year, table, sumlevel) %>% mutate(variable = "0 vehicles available", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(4,11), GEOID, year, table, sumlevel) %>% mutate(variable = "1 vehicle available", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(5:8,12:15), GEOID, year, table, sumlevel) %>% mutate(variable = "2 or more vehicles available", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(3), GEOID, year, table, sumlevel) %>% mutate(variable = "0 vehicles available", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(4), GEOID, year, table, sumlevel) %>% mutate(variable = "1 vehicle available", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(5:8), GEOID, year, table, sumlevel) %>% mutate(variable = "2 or more vehicles available", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Owners", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(10), GEOID, year, table, sumlevel) %>% mutate(variable = "0 vehicles available", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(11), GEOID, year, table, sumlevel) %>% mutate(variable = "1 vehicle available", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(12:15), GEOID, year, table, sumlevel) %>% mutate(variable = "2 or more vehicles available", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability"),
    vehicles %>% aggregate_long_varnum(., varnums2collapse = c(9), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "Renters", universe = "Occupied Housing Units", parameter = "Total", topic = "Vehicle Availability")
    
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}


aggregate_broadband_race <- function(df){
  comp_w_broadband_by_race <- df %>%
    filter(substr(table, 1, 6) == 'B28009',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) %>%
    mutate(subgroup = var2race(variable))
  
  internet_race_aggd <- rbind(
    comp_w_broadband_by_race %>% aggregate_long_varnum(., varnums2collapse = c(4), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Has computer with broadband", universe = paste0("Population in households who are ", subgroup), parameter = "Total", topic = "Internet Access"),
    comp_w_broadband_by_race %>% aggregate_long_varnum(., varnums2collapse = c(6,5), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "No computer and/or no internet", universe = paste0("Population in households who are ", subgroup), parameter = "Total", topic = "Internet Access"),
    comp_w_broadband_by_race %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Total population in households", universe = paste0("Population in households who are ", subgroup), parameter = "Total", topic = "Internet Access")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population in households") %>%
    filter(!(parameter == "Percent" & variable == "Total population in households"))
}




aggregate_disability_race <- function(df){
  disability <- df %>%
    filter(substr(table, 1, 6) == 'B18101',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) %>%
    mutate(subgroup = var2race(variable))
  
  disability_by_age <- disability %>% filter(subgroup == "All")
  disability_by_race_by_age <- disability %>% filter(subgroup != "All")
  
  disability_status <- rbind(
    disability_by_race_by_age %>% aggregate_long_varnum(., varnums2collapse = c(3,6,9), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "With a disability", universe = paste0("Civilian noninstitutionalized population who are ", subgroup), parameter = "Total", topic = "Disability"),
    disability_by_race_by_age %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, subgroup, table, sumlevel) %>% mutate(variable = "Total civilian noninstitutionalized population", universe = paste0("Civilian noninstitutionalized population who are ", subgroup), parameter = "Total", topic = "Disability"),
    disability_by_age %>% aggregate_long_varnum(., varnums2collapse = c(4,7,10,13,16,19,23,26,29,32,35,38), GEOID, year, table, sumlevel) %>% mutate(variable = "With a disability", subgroup = "All", universe = "Civilian noninstitutionalized population", parameter = "Total", topic = "Disability"),
    disability_by_age %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total civilian noninstitutionalized population", subgroup = "All", universe = "Civilian noninstitutionalized population", parameter = "Total", topic = "Disability"),
    disability_by_age %>% aggregate_long_varnum(., varnums2collapse = c(16, 19, 35, 38), GEOID, year, table, sumlevel) %>% mutate(variable = "With a disability", subgroup = "Elders 65+", universe = "Civilian noninstitutionalized population", parameter = "Total", topic = "Disability"),
    disability_by_age %>% aggregate_long_varnum(., varnums2collapse = c(15, 18, 34, 37), GEOID, year, table, sumlevel) %>% mutate(variable = "Total civilian noninstitutionalized population", subgroup = "Elders 65+", universe = "Civilian noninstitutionalized population", parameter = "Total", topic = "Disability")
  )  %>% ungroup() %>%
    add_pct(., total_var = "Total civilian noninstitutionalized population") %>%
    filter(!(parameter == "Percent" & variable == "Total civilian noninstitutionalized population"))
  
}


aggregate_lep_households <- function(df){
  lep <- df %>%
    filter(table %in% c('C16002', 'B16002'),
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  lep_aggd <- rbind(
    lep %>% aggregate_long_varnum(., varnums2collapse = c(4, 7, 10, 13), GEOID, year, table, sumlevel) %>% mutate(variable = "LEP Households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Limited English Proficiency"),
    lep %>% aggregate_long_varnum(., varnums2collapse = c(5, 8, 11, 14), GEOID, year, table, sumlevel) %>% mutate(variable = "Non-LEP Households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Limited English Proficiency"),
    lep %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total households", subgroup = "All", universe = "Households", parameter = "Total", topic = "Limited English Proficiency")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total households") %>%
    filter(!(parameter == "Percent" & variable == "Total households"))
}



aggregate_health_insurance <- function(df){
  insurance <- df %>%
    filter(table == 'B27010',
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) 
  
  insurance_aggd <- rbind(
    insurance %>% aggregate_long_varnum(., varnums2collapse = c(17,33,50,66), GEOID, year, table, sumlevel) %>% mutate(variable = "No health insurance coverage", subgroup = "All", universe = "Civilian Noninstitutionalized Population", parameter = "Total", topic = "Health Insurance"),
    insurance %>% aggregate_long_varnum(., varnums2collapse = c(3,10,19,26,35,42,52,58), GEOID, year, table, sumlevel) %>% mutate(variable = "With any health insurance coverage", subgroup = "All", universe = "Civilian Noninstitutionalized Population", parameter = "Total", topic = "Health Insurance"),
    insurance %>% aggregate_long_varnum(., varnums2collapse = c(4,20,36,53), GEOID, year, table, sumlevel) %>% mutate(variable = "With employer-based health insurance coverage only", subgroup = "All", universe = "Civilian Noninstitutionalized Population", parameter = "Total", topic = "Health Insurance"),
    insurance %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total civilian noninstitutionalized population", subgroup = "All", universe = "Civilian Noninstitutionalized Population", parameter = "Total", topic = "Health Insurance")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total civilian noninstitutionalized population") %>%
    filter(!(parameter == "Percent" & variable == "Total civilian noninstitutionalized population"))
}



########### Medians ###########

codebook_medians <- "./1_data/0_resources/acs_pareto_median_codebook.xlsx"

## Not used right now, but will be handy when I make function to calculate MoE for median values
design_factors <- rio::import(codebook_medians, which = "design_factors") %>%
  select(DF = DESIGN_FACTOR, table)

## Read codebook that defines intervals for gross rent
gross_rent_codebook <- rio::import(codebook_medians, which = "B25063") %>%
  filter(!is.na(range_category)) %>% select(-label)

age_codebook <- rio::import(codebook_medians, which = "B01001") %>%
  filter(!is.na(range_category)) %>% select(-label)

monthly_owner_costs_codebook <- rio::import(codebook_medians, which = "B25087") %>%
  filter(!is.na(range_category)) %>% select(-label)

household_income_codebook <- rio::import(codebook_medians, which = "B19001") %>%
  filter(!is.na(range_category)) %>% select(-label)

year_built_codebook <- rio::import(codebook_medians, which = "B25034") %>%
  filter(!is.na(range_category)) %>% select(-label)

travel_time_codebook <- rio::import(codebook_medians, which = "B08303") %>%
  filter(!is.na(range_category)) %>% select(-label)



calc_median_from_group <- function(df, codebook, geoid_filter, DF_codebook = NULL, year = NULL){
  ## df should be a dataframe containing only one acs table
  
  ## Supply year variable if not present
  if(!("year" %in% names(df))){
    if(is.null(year)){message("Must supply ACS year value in function parameter.")}
    df <- mutate(df, year = year)}
  
  summary <- df %>% 
    left_join(., codebook, by = c("variable", "year")) %>%
    filter(!is.na(range_category),
           GEOID %in% geoid_filter) %>%
    group_by(range_category, group) %>%
    summarize(estimate = sum(estimate, na.rm = T),
              moe = moe_sum(moe = moe, ## TODO Calculate MoE for pareto median
                            estimate = estimate, 
                            na.rm = T))
  
  grouped_median(df = summary, freq_col = "estimate", interval_col = "range_category", sep = "t")
}

## Example:
# median_hhinc <- data %>%
#   filter(table == "B19001") %>% 
#   split(.$year) %>%
#   map_dfr(.f = calc_median_from_group,
#           codebook = household_income_codebook, geoid_filter = lower_se) %>%
#   pivot_longer(cols = everything(), names_to = "year") %>%
#   mutate(variable = "Median Household Income")


calc_median_ownercosts <- function(df, codebook, geoid_filter, DF_codebook = NULL, year = NULL){
  ## Fucntion specifically for owner costs, since the table is reported in two groups with different bins
  
  ## df should be a dataframe containing only one acs table
  
  ## Supply year variable if not present
  if(!("year" %in% names(df))){
    if(is.null(year)){message("Must supply ACS year value in function parameter.")}
    df <- mutate(df, year = year)}
  
  summary <- df %>% 
    left_join(., codebook, by = c("variable", "year")) %>%
    filter(!is.na(range_category),
           GEOID %in% geoid_filter) %>%
    group_by(range_category, group) %>%
    summarize(estimate = sum(estimate, na.rm = T),
              moe = moe_sum(moe = moe, ## TODO Calculate MoE for pareto median
                            estimate = estimate, 
                            na.rm = T))
  
  # return(summary)
  
  s1 <- summary %>% ungroup() %>% filter(group == "WITH")
  s2 <- summary %>% ungroup() %>% filter(group == "WITHOUT")
  
  # return(s1)
  
  return(data.frame(
    WITH = grouped_median(df = s1, freq_col = "estimate", interval_col = "range_category", sep = "t"),
    WITHOUT = grouped_median(df = s2, freq_col = "estimate", interval_col = "range_category", sep = "t")
  ))
}




##### Weighted averages #####

calc_weighted_average <- function(df, geoid_filter, weight_var, value_var){
  
  weights <- filter(df, variable == weight_var) %>% select(GEOID, weight = estimate, year)
  
  df %>%
    filter(GEOID %in% geoid_filter,
           variable == value_var) %>%
    left_join(., weights, by = c("GEOID", "year")) %>%
    mutate(weighted_estimate = estimate * weight) %>%
    group_by(year) %>%
    summarize(estimate = sum(weighted_estimate) / sum(weight))
}





##### Decennial Census 2000 Adaptations #####
aggregate_race_2000 <- function(df){
  race <- df %>%
    filter(table == 'SF1_P004') 
  
  race_aggd <- rbind(
    race %>% aggregate_long_varnum(., varnums2collapse = c(5), GEOID, year, table, sumlevel) %>% mutate(variable = "White alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(6), GEOID, year, table, sumlevel) %>% mutate(variable = "Black alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(7), GEOID, year, table, sumlevel) %>% mutate(variable = "Native American alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(8), GEOID, year, table, sumlevel) %>% mutate(variable = "Asian alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(9), GEOID, year, table, sumlevel) %>% mutate(variable = "Hawaiian or Pacific Islander alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(10), GEOID, year, table, sumlevel) %>% mutate(variable = "Another race alone, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(11), GEOID, year, table, sumlevel) %>% mutate(variable = "Two or more races, not Hispanic", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(2), GEOID, year, table, sumlevel) %>% mutate(variable = "Hispanic or Latino", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(6, 7, 2), GEOID, year, table, sumlevel) %>% mutate(variable = "Black, Indigenous, Latinx", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(6,7,8,9,10,11,2), GEOID, year, table, sumlevel) %>% mutate(variable = "People of Color", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race"),
    race %>% aggregate_long_varnum(., varnums2collapse = c(1), GEOID, year, table, sumlevel) %>% mutate(variable = "Total population", subgroup = "All", universe = "Total Population", parameter = "Total", topic = "Race")
  ) %>% ungroup() %>%
    add_pct(., total_var = "Total population") %>%
    filter(!(parameter == "Percent" & variable == "Total population"))
}

aggregate_median_hh_income <- function(df, cpi = cpi, inflation_factor = "inflation_factor_2019"){
  mhi <- df %>%
    filter(table %in% c("B19013", "SF3_P053"),
           (sumlevel == "tract" & substr(GEOID, 1, 5) %in% MSA_DEFINITION) |
             sumlevel == "place" & GEOID %in% PLACES_TO_DOWNLOAD) %>%
    left_join(., cpi, by = "year") %>%
    mutate(subgroup = "All",
           est = estimate * !!sym(inflation_factor),
           moe = moe * !!sym(inflation_factor),
           variable = "Median household income", universe = "Households", parameter = "Total", topic = "Income") %>%
    mutate(summary_variable = NA_character_) %>%
    select(GEOID, year, parameter, subgroup, variable, est, moe, summary_variable, universe, topic, table, sumlevel) %>%
    arrange(GEOID, year, variable, subgroup) %>%
    filter(!(parameter == "Percent" & variable == "Total"))
}
