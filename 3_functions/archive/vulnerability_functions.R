
assign_vulnerability_bates <- function(df){
  
  vulnerability_variables <- c("No four-year degree", "People of Color", 
                               "Low-income (0-80% MFI)", "Renters")
  
  place_baseline <- df %>%
    filter(GEOID == PRINCIPAL_PLACE_GEOID,
           parameter == "Percent",
           variable %in% vulnerability_variables) %>%
    mutate(place_est_lb = est - moe,
           place_est_ub = est + moe) %>%
    select(year, variable, place_est = est, place_est_lb, place_est_ub, place_moe = moe)
  
  df %>%
    filter(in_place == TRUE, 
           parameter == "Percent",
           variable %in% vulnerability_variables) %>%
    left_join(., place_baseline, by = c("year", "variable")) %>% 
    arrange(GEOID, variable, desc(year)) %>% 
    group_by(GEOID, year, variable) %>%
    mutate(gt_place = ifelse(est >= place_est_lb, 1, 0)) %>% ## Greater than place average?
    ungroup() %>% group_by(GEOID, year) %>%
    summarize(vulnerability_score_bates = sum(gt_place)) %>% ## Vulnerability score Bates method
    mutate(is_vulnerable_bates = if_else(vulnerability_score_bates >= 3, TRUE, FALSE))
}


assign_vulnerability_quintile <- function(df, MIN_QUINTILE_SCORE = 15, MIN_PERCENTILE_SCORE = 0.7){
  vulnerability_variables <- c("No four-year degree", "People of Color", 
                               "Low-income (0-80% MFI)", "Renters")
  
  ## This approach calculates two alternative methods: quintile scores and
  ## percentile scores using cume_dist. The current appraoch uses the quintile-based
  ## approach. Focus on the rnk or rnksum or is_vulnerable_percentile variables 
  ## to enable percentile rank score approach.
  df %>%
    filter(in_place == TRUE, 
           parameter == "Percent",
           variable %in% vulnerability_variables) %>%
    select(GEOID, year, variable, est) %>%
    group_by(year, variable) %>%
    mutate(rnk = cume_dist(est), # Percentile score
           qn = quintile(est)) %>% # Quintile score
    ungroup() %>% ##->> TMP
    group_by(GEOID, year) %>%
    summarize(rnksum = sum(rnk, na.rm = T), # Sum of percentile scores
              vulnerability_score_quintile = sum(qn, na.rm = T)) %>% # Sum of quintile scores
    ungroup() %>% group_by(year) %>%
    mutate(
      # stretch percentile score to 01
      vulnerability_score_percentile = range01(rnksum, na.rm = T), 
      # is vulnerable using standard method
      is_vulnerable_quintile = ifelse(vulnerability_score_quintile >= MIN_QUINTILE_SCORE, TRUE, FALSE), 
      #  is vulnerable using cume_dist method <- this one seems more conservative (more tracts light up)
      is_vulnerable_percentile = ifelse(vulnerability_score_percentile >= MIN_PERCENTILE_SCORE, TRUE, FALSE)
    )
}