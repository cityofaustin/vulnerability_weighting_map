source("3_functions/GLOBAL_CONSTANTS.R")
source("3_functions/statistical_functions.R")

determine_demographic_change <- function(df_long, year1, year2) {
  
  # demographic_data_subset <- readRDS("1_data/3_processed/demographic_subset_2000t2019_20220307.rds")
  # {
  #   df_long <- demographic_data_subset 
  #   year1 <- 2010
  #   year2 <- 2019
  # }
  
  df_long <- df_long %>%
    filter(parameter == "Percent" | substr(variable, 1, 6) == "Median")
  
  y1c <- year1
  y2c <- year2
  overlap <- if_else(y2c - y1c < 5, TRUE, FALSE)
  
  y1 <- df_long %>% filter(year == y1c)
  y2 <- df_long %>% filter(year == y2c)
  
  ## Join two years together, perform calculations
  ## TODO Incorporate citywide percentage POINT difference as reference (Bates 2013 pg 60)
  chg <- inner_join(y1, y2, by = c("GEOID", "parameter", "variable"), 
                    suffix = c(paste0(".",y1c), paste0(".", y2c))) %>%
    # filter(GEOID != "41051980000") %>%
    mutate(y1 = y1c,
           y2 = y2c,
           ydif = y2c - y1c)
  
  chg2 <- chg %>%
    mutate(pctchg_y1ty2_est = ( !!sym(paste0("est.", y2c)) - !!sym(paste0("est.", y1c)) ) / !!sym(paste0("est.", y1c)),
           pctchg_y1ty2_moe = moe_chgprop(moe_y1 = !!sym(paste0("moe.", y1c)), 
                                          moe_y2 = !!sym(paste0("moe.", y2c)), 
                                          est_y1 = !!sym(paste0("est.", y1c)), 
                                          est_y2 = !!sym(paste0("est.", y2c)) ),
           pctchg_y1ty2_lb = pctchg_y1ty2_est - pctchg_y1ty2_moe,
           pctchg_y1ty2_ub = pctchg_y1ty2_est + pctchg_y1ty2_moe,
           
           flag_sig = sig_test(est_y1 = !!sym(paste0("est.", y1c)), 
                               est_y2 = !!sym(paste0("est.", y2c)), 
                               moe_y1 = !!sym(paste0("moe.", y1c)), 
                               moe_y2 = !!sym(paste0("moe.", y2c)) )) %>% 
    group_by(variable, parameter) %>%
    mutate(different_than_pdx = sig_test(est_y1 = pctchg_y1ty2_est[GEOID == PRINCIPAL_PLACE_GEOID],
                                         est_y2 = pctchg_y1ty2_est,
                                         moe_y1 = pctchg_y1ty2_moe[GEOID == PRINCIPAL_PLACE_GEOID],
                                         moe_y2 = pctchg_y1ty2_moe),
           chg_gt_pdx_lb = if_else(pctchg_y1ty2_est > pctchg_y1ty2_lb[GEOID == PRINCIPAL_PLACE_GEOID], 1, 0), # add ` & different_than_pdx` to identify significant changes
           chg_wmoe_gt_pdx_lb = if_else(pctchg_y1ty2_est + pctchg_y1ty2_moe > pctchg_y1ty2_lb[GEOID == PRINCIPAL_PLACE_GEOID], 1, 0), # with margin of error added
           chg_lt_pdx_ub = if_else(pctchg_y1ty2_est < pctchg_y1ty2_ub[GEOID == PRINCIPAL_PLACE_GEOID], 1, 0)) %>% ungroup()
  # }
  
  
  ### Pivot change summary to wide format, sum indicators, determine change outcome
  chg_demo <- chg2 %>% select(GEOID, variable, chg_gt_pdx_lb) %>%
    pivot_wider(names_from = variable, values_from = chg_gt_pdx_lb) %>%
    janitor::clean_names() %>% #glimpse()
    mutate(flag_demochange = case_when(
      owners + bachelors_or_higher + white_alone_not_hispanic + median_household_income >= 3 ~ "Demographic change",
      bachelors_or_higher + white_alone_not_hispanic == 2 ~ "Demographic change",
      TRUE ~ "No demographic change")) %>%
    select(GEOID = geoid, owners, bachelors_or_higher, white_alone_not_hispanic, median_household_income, flag_demochange)
  return(chg_demo)
}