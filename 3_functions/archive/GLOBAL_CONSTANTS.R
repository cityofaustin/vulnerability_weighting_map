library(sf)
source("3_functions/utility_functions.R")

## File locations
GDB <- "1_data/1_original/shapes/COV_DisplacementData_Nick.gdb"
CITY_BOUNDARY_LAYER <- "VanUtilityBoundary"
TRACT_LAYER <- "CensusTracts_VanAOI"
TARGET_EPSG <- 2286

## MSA shortname list
msa_shortname <- rio::import("./1_data/0_resources/msa_shortname_brookings.xlsx") %>%
  rename(cbsa13 = `CBSA FIPS (2013)`, cbsa_shortname = `CBSA Short Name (2013)`) #%>% filter(cbsa13 %in% msas$GEOID)

## County to MSA crosswalk
county2msa <- read.csv(textConnection(readLines("./1_data/0_resources/geocorr2014_county_to_msa.csv")[-2]), 
                       colClasses = c("character", "character", "character", "character", "integer", "integer"), 
                       header = TRUE, sep=",") %>%
  left_join(., msa_shortname, by = c("cbsa" = "cbsa13"))

## Search for the correct cbsa code for the region you are interested in
# county2msa %>% filter(str_detect(cbsaname15, regex("vancouver", ignore_case = TRUE)))

## Determine counties from region CBSA code determined above
MSA_DEFINITION <- get_counties_from_cbsa(38900)

## Determine states from counties
STATES_TO_DOWNLOAD <- get_states_from_stcnty_fips(MSA_DEFINITION)
COUNTIES_TO_DOWNLOAD <- substr(MSA_DEFINITION, 3, 5)

## GEOID/FIPS code of places you want to download to be able to compare
## TODO Automate so users don't have to manually enter this
PLACES_TO_DOWNLOAD <- c(5374060, 4159000, 5363000, 4105800, 4105350, 4131250, 4134100, 4164900, 4123850, 5370000)

## GEOID/FIPS code of the primary place of interest
PRINCIPAL_PLACE_GEOID <- '5374060'

COUNTY_NAME <- "Clark"
STATE_ABBR <- "WA"

MASTER_TRACT_LIST_IN_PLACE <- 
  c('53011040703', '53011040706', '53011040707', '53011040711', '53011040712', 
    '53011040806', '53011041003', '53011041005', '53011041011', '53011041104', 
    '53011041105', '53011041107', '53011041108', '53011041110', '53011041111', 
    '53011041112', '53011041201', '53011041203', '53011041205', '53011041206', 
    '53011041309', '53011041310', '53011041312', '53011041313', '53011041317', 
    '53011041318', '53011041319', '53011041320', '53011041321', '53011041322', 
    '53011041323', '53011041325', '53011041326', '53011041327', '53011041328', 
    '53011041329', '53011041330', '53011041331', '53011041332', '53011041333', 
    '53011041600', '53011041700', '53011041800', '53011041900', '53011042000', 
    '53011042100', '53011042300', '53011042400', '53011042500', '53011042600', 
    '53011042700', '53011042800', '53011042900', '53011043000', '53011043100', 
    '53011041324', '53011040705', '53011041314', '53011041316', '53011041002', 
    '53011041109', '53011041315')

TRACTS_IN_PLACE.SF <- st_read(GDB, TRACT_LAYER) %>% st_transform(TARGET_EPSG) %>% select(GEOID)

TRACTS_IN_PLACE_GEOID <- TRACTS_IN_PLACE.SF %>% pull(GEOID)

TRACTS_IN_PLACE.SF <- tigris::tracts(state = STATE_ABBR, county = COUNTY_NAME, cb = FALSE, year = 2019) %>%
  select(GEOID) %>% filter(GEOID %in% MASTER_TRACT_LIST_IN_PLACE) %>% st_transform(TARGET_EPSG)


