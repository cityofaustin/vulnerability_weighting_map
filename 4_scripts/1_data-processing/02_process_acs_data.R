## This script queries American Community Survey data for a user-defined metro area and
## produces a table with pre-selected vulnerability indicators. You can change the metro
## area to your own community to download the data and export it for use in the shiny app.
## This script assumes you will download regional data and also a "core" city for that 
## region. Make sure you adjust the `primary_place` variable if you seek an alternate city
## within a region.

library(tidyverse)
library(tidycensus)
library(sf)
library(tigris)
library(furrr)

options(
  scipen = 999,
  digits = 4,
  tigris_class = "sf",
  tigris_use_cache = T
)

## Source script that establishes geographic constants for this application
source("GLOBAL.R")
source("3_functions/aggregate_variables.R")

## Download data using tidycensus #####
## View potential variables available to use
acs20 <- load_variables(2020, "acs5", cache = TRUE)
s20 <- load_variables(2020, "acs5/subject", cache = TRUE)

## Desired variables ####
# B03002 People of color 
# B03002 Black, Native and Latinx people
# C16002 Households with limited English
# B19013 Median household income 
# B19058 Food stamps recipients
# B25003 Renter households
# B23025 Unemployed persons
# B25070 Rent cost burdened
# B25091 Mortgage cost burdened
# B08006 Commuters
# B08203 Insufficient commuter vehicles
# B18101 Persons with disabilities
# B15002 Adults without a 4-yr degree
# B14001 Students (K-12)
# B01001 Retirees (65+)
# B25014 Overcrowded households
# B28001 No computer access
# B28002 No broadband access

tables_to_download <- c(
  "B01001", "B15002", "B25014", "C16002", "B23025", "B08006",
  "B14001", "B28002", "B08203", "B25091", "B25070", "B18101",
  "B03002", "B25003", "B19013", "B19058", "B28001")

## Enable multi-core processing
plan(multisession, workers = availableCores())

acs_table_query <- future_map_dfr(
  .x = tables_to_download,
  .f = function(acs_table){
    query <- get_acs(geography = "tract", 
                     table = acs_table, 
                     year = 2020, 
                     state = STATES_TO_DOWNLOAD) %>%
      filter(substr(GEOID, 1, 5) %in% COUNTIES_TO_DOWNLOAD) %>%
      mutate(agg = "count") %>%
      select(-NAME)
  }) 

## Aggregate data
poc <- aggregate_variables(
  acs_table_query, agg_table = "B03002", varnums = c(4:9,12),
  summary_var = "B03002_001", varname = "People of color")

bnl <- aggregate_variables(
  acs_table_query, agg_table = "B03002", varnums = c(4,7,12),
  summary_var = "B03002_001", varname = "Black, Native and Latinx people")

lep <- aggregate_variables(
  acs_table_query, agg_table = "C16002", varnums = c(4,7,10,13),
  summary_var = "C16002_001", varname = "Households with limited English")

# Special case -- just change it for formatting
mhi <- acs_table_query %>% filter(variable == "B19013_001") %>%
  mutate(agg = "median", variable = "Median household income",
         table = "B19013", varnum = 1) 

food_stamps <- aggregate_variables(
  acs_table_query, agg_table = "B19058", varnums = c(2),
  summary_var = "B19058_001", varname = "Food stamps recipients")

renters <- aggregate_variables(
  acs_table_query, agg_table = "B25003", varnums = c(3),
  summary_var = "B25003_001", varname = "Renter households")

unemployed_persons <- aggregate_variables(
  acs_table_query, agg_table = "B23025", varnums = c(5),
  summary_var = "B23025_001", varname = "Unemployed persons")

rent_hcb <- aggregate_variables(
  acs_table_query, agg_table = "B25070", varnums = c(8,9,10),
  summary_var = "B25070_001", varname = "Cost-burdened renters (35%+)")

mortgage_hcb <- aggregate_variables(
  acs_table_query, agg_table = "B25091", varnums = c(9,10,11),
  summary_var = "B25091_002", varname = "Cost-burdened owners with mortgage (35%+)")

commuters <- aggregate_variables(
  acs_table_query, agg_table = "B08006", varnums = c(2,8,14,15,16),
  summary_var = "B08006_001", varname = "Commuters")

# Special case -- three summary variables
insuff_veh <- aggregate_variables(
  acs_table_query, agg_table = "B08203", varnums = c(14,20,21,26,27,28),
  summary_var = c("B08203_013", "B08203_019", "B08203_025"), 
  varname = "Insufficient commuter vehicles")

disabled <- aggregate_variables(
  acs_table_query, agg_table = "B18101", varnums = c(4,7,10,13,16,19,23,26,29,32,35,38),
  summary_var = "B18101_001", varname = "Persons with disabilities")

no4yr <- aggregate_variables(
  acs_table_query, agg_table = "B15002", varnums = c(3:14, 20:31),
  summary_var = "B15002_001", varname = "Adults without 4-yr degree")

students <- aggregate_variables(
  acs_table_query, agg_table = "B14001", varnums = c(3:7),
  summary_var = "B14001_001", varname = "Students (K-12)")

retirees <- aggregate_variables(
  acs_table_query, agg_table = "B01001", varnums = c(20:25, 44:49),
  summary_var = "B01001_001", varname = "Retirees (65+)")

overcrowded_hh <- aggregate_variables(
  acs_table_query, agg_table = "B25014", varnums = c(5,6,7,11,12,13),
  summary_var = "B25014_001", varname = "Overcrowded households")

no_computer <- aggregate_variables(
  acs_table_query, agg_table = "B28001", varnums = c(11),
  summary_var = "B28001_001", varname = "No computer access")

no_broadband <- aggregate_variables(
  acs_table_query, agg_table = "B28002", varnums = c(3,6,12,13),
  summary_var = "B28002_001", varname = "No broadband access")

## Combine all the aggregated data together
acs_data_aggregated <- rbind(
  poc, bnl, lep, mhi, food_stamps, renters, unemployed_persons,
  rent_hcb, mortgage_hcb, commuters, insuff_veh, disabled, no4yr,
  students, retirees, overcrowded_hh, no_computer, no_broadband)


## Clean up original query (reconcile names) and rbind to aggregated data
all_data <- acs_table_query %>%
  separate(., variable, into = c("table", "varnum"),
           sep = "_", remove = F) %>%
  mutate(varnum = as.numeric(varnum)) %>%
  rbind(acs_data_aggregated, .)

## For the app, transform the long data to wide format and export
wide_data <- acs_data_aggregated %>%
  filter(agg %in% c("percent", "median")) %>%
  select(GEOID, variable, E = estimate) %>% #, M = moe) %>%
  pivot_wider(id_cols = GEOID, names_from = variable, values_from = c(E)) %>%
  janitor::clean_names() %>% rename(GEOID = geoid) %>%
  left_join(., TRACTS.SF) %>%
  st_as_sf() %>%
  select(everything(), county = NAMELSADCO, -c(STATEFP:STUSPS, STATE_NAME:AWATER)) %>%
  mutate(county = str_replace(county, " County", " Co."),
         renter_households = ifelse(is.na(renter_households), 0, renter_households),
         cost_burdened_renters_35_percent = ifelse(is.na(cost_burdened_renters_35_percent), 0, cost_burdened_renters_35_percent),
         cost_burdened_owners_with_mortgage_35_percent = ifelse(is.na(cost_burdened_owners_with_mortgage_35_percent), 0, cost_burdened_owners_with_mortgage_35_percent))


## Export data #####
saveRDS(wide_data, "1_data/3_processed/acs_vuln_weighting_data.rds")
saveRDS(all_data, "1_data/3_processed/acs_vuln_weighting_data_full.rds")

# wide_data <- readRDS("1_data/3_processed/acs_vuln_weighting_data.rds")
# all_data <- readRDS("1_data/3_processed/acs_vuln_weighting_data_full.rds")

# ## Optionally view map
# library(mapview)
# mapview::mapview(wide_data, zcol = "in_primary_place") +
#   mapview::mapview(PRIMARY_PLACE)

# wide_data %>%
#   st_transform(WEB_EPSG) %>%
#   mapview(zcol = "in_primary_place")
